# Chalk v1.2.2 — Code Review Issues

Post-review of the Clever-compatible SSO, ClassLink-compatible SSO, and AD Sync implementations. All three features are functional and well-structured. The following issues should be addressed before pilot district deployment.

## Critical (Fix Before Pilot)

### 1. `find_user_by_clever_id` is O(n) — full table scan

**File:** `crates/idp/src/clever_compat.rs` lines 1018–1041

The function loads every user via `list_users()` then iterates with a separate `get_external_ids()` call per user. For a 5K-user district, that's 5,001 DB queries per `/v3.0/users/{id}` API call.

**Fix:** Add a SQL query that searches the `external_ids` JSON column directly, or add a dedicated `external_id_lookup` table with `(provider, external_id) → sourced_id` mapping and an index. The latter is cleaner and avoids JSON query syntax differences across SQLite/Postgres.

### 2. ClassLink `sourced_id_to_integer` uses non-deterministic hasher

**File:** `crates/idp/src/classlink_compat.rs` lines 362–367

`std::collections::hash_map::DefaultHasher` is explicitly not guaranteed stable across Rust versions. If the binary is recompiled with a different toolchain, all ClassLink user IDs change and vendor-side user matching breaks silently.

**Fix:** Use a deterministic hash (SHA256 truncated to i64, or FNV/SipHash with a fixed seed), or store the numeric mapping in `external_ids` like the Clever implementation does. Storing it is the safer option since it also survives algorithm changes.

### 3. `chalk migrate --from clever` not implemented

**File:** `crates/cli/src/commands/` (missing)

The README advertises `chalk migrate` and the migration docs exist (`docs/migration-clever.md`, `docs/migration-classlink.md`), but there's no actual CLI command implementation. This is the primary sales tool — it's what makes a 30-minute pilot demo possible and eliminates the biggest objection ("migration is too hard").

**Scope:** At minimum, implement `chalk migrate --from clever --clever-token {token}` that:
1. Pulls district data via Clever's Data API (students, teachers, schools, sections)
2. Imports into Chalk's roster tables
3. Preserves Clever IDs in `external_ids` so Clever-compat SSO works immediately
4. Generates TOML entries for each SSO partner with `protocol = "clever-compat"`
5. Outputs a migration report (users imported, partners detected, next steps)

Also implement `chalk migrate --from oneroster --path {csv_dir}` as a fallback for districts not on Clever. ClassLink migration can follow later.

## Important (Fix Before Scale)

### 4. Access tokens stored as `OidcAuthorizationCode` records

**Files:** `crates/idp/src/clever_compat.rs` line 383–398, `crates/idp/src/classlink_compat.rs` lines 302–320

Both implementations store access tokens in the `oidc_authorization_codes` table with scope prefixed `"access_token "` to distinguish them from actual auth codes. This works but creates ambiguity — the struct name is misleading, there's no separate TTL management, and token revocation would require scanning by scope prefix.

**Fix:** Add a dedicated `access_tokens` table with proper fields (token, user_id, client_id, scopes, expires_at, revoked_at). Migrate both Clever and ClassLink implementations to use it.

### 5. AD Sync group management not implemented

**Files:** `crates/core/src/config.rs` lines 294–302, `crates/ad-sync/src/sync.rs`

The `AdGroupConfig` struct and `manage_groups` option are parsed from TOML but never used in `execute_sync()`. The Clever IDM doc shows group management is a key feature districts expect — placing users in security/distribution groups by school, grade, etc.

**Fix:** Implement group sync in `execute_sync()` after user create/update: create groups if missing, add users to groups based on school/grade/role, remove users from old groups on school transfer.

### 6. `role_to_clever_type` catch-all defaults to "student"

**File:** `crates/idp/src/clever_compat.rs` lines 1044–1051

Any unrecognized role (Aide, Proctor, Guardian, Relative, etc.) maps to `"student"`. Clever's actual API returns `"staff"` for non-teaching staff. A district admin appearing as a student to a vendor would cause permission issues.

**Fix:** Map the catch-all to `"staff"` instead of `"student"`. Also add explicit mappings for `Aide`, `Proctor`, `Guardian`, and `Relative` if those exist in the `RoleType` enum.

## Cleanup (Tech Debt)

### 7. Duplicate helper functions across Clever and ClassLink modules

**Files:** `crates/idp/src/clever_compat.rs`, `crates/idp/src/classlink_compat.rs`

`extract_client_credentials`, `generate_random_hex`, and `extract_cookie` are duplicated between both files.

**Fix:** Extract shared helpers into a `crates/idp/src/compat_common.rs` module and import from both.

### 8. Entra ID (Microsoft Graph) sync not yet implemented

**File:** `crates/ad-sync/`

AD sync currently supports on-prem LDAP only. Cloud-only districts using Entra ID (Azure AD) will need Microsoft Graph API support. This was scoped as P1.

**No immediate fix needed.** Track as a follow-up feature after LDAP-based AD sync is validated with pilot districts.